{% extends 'base.html' %}

<!-- templates/job_application.html -->

{% block content %}
<div class="book-antiqua">
    <h1>Job Application</h1>
</div>

<form method="post" novalidate>
    {% csrf_token %}
    <div class="section-header">
        <h2>Section 1: Name and Date</h2>
        <button type="button" class="toggle-section" data-target="#section1-content">-</button>
    </div>
    <div id="section1-content" class="collapsible-content expanded">
        {{ form.non_field_errors }}
        <div>
            {{ form.applicant_name.label_tag }} {{ form.applicant_name }}
        </div>
        <div>
            {{ form.date_of_application.label_tag }} {{ form.date_of_application }}
        </div>
        <div>
            {{ form.email_address.label_tag }} {{ form.email_address }}
        </div>
        <p>In compliance with Federal and State equal employment opportunity laws, qualified applicants
            are considered for all positions without regard to race, color, religion, sex, national origin, age,
            marital status, veteran status, non-job related disability, or any other protected group status.</p>
    </div>
    <div class="section-header">
        <h2>Section 2: Applicant Information</h2>
        <button type="button" class="toggle-section" data-target="#section2-content">+</button>
    </div>
    <div id="section2-content" class="collapsible-content collapsed">
        <div>
            {{ form.position_applied_for.label_tag }} {{ form.position_applied_for }}
        </div>
        <div>
            {{ form.address.label_tag }} {{ form.address }}
        </div>
        <div>
            {{ form.city.label_tag }} {{ form.city }}
        </div>
        <div>
            {{ form.state.label_tag }} {{ form.state }}
        </div>
        <div>
            {{ form.zip.label_tag }} {{ form.zip }}
        </div>
        <div>
            {{ form.phone_number.label_tag }} {{ form.phone_number }}
        </div>
        <div>
            {{ form.social_security_number.label_tag }} {{ form.social_security_number }}
        </div>
        <div>
            {{ form.date_of_birth.label_tag }} {{ form.date_of_birth }}
        </div>
        <div class="form-row">
            {{ form.proof_of_age.label_tag }} {{ form.proof_of_age }}
        </div>
        <div class="form-row">
            {{ form.worked_here_before.label_tag }} {{ form.worked_here_before }}
        </div>
        <div id="conditional-fields-1" style="display: none;">
            <div>
                {{ form.worked_here_location.label_tag }} {{ form.worked_here_location }}
            </div>
            <div>
                {{ form.worked_here_from.label_tag }} {{ form.worked_here_from }}
            </div>
            <div>
                {{ form.worked_here_to.label_tag }} {{ form.worked_here_to }}
            </div>
            <div>
                {{ form.rate_of_pay.label_tag }}
                <div class="monetary-field-container">
                    {{ form.rate_of_pay }}
                </div>
            </div>
            <div>
                {{ form.previous_position.label_tag }} {{ form.previous_position }}
            </div>
            <div>
                {{ form.reason_for_leaving_here.label_tag }} {{ form.reason_for_leaving_here }}
            </div>
        </div>
        <div class="form-row">
            {{ form.currently_employed.label_tag }} {{ form.currently_employed }}
        </div>
        <div id="conditional-fields-2" style="display: none;">
            <div>
            {{ form.time_since_previously_employed.label_tag }} {{ form.time_since_previously_employed }}
        </div>
        </div>
        <div>
            {{ form.who_referred.label_tag }} {{ form.who_referred }}
        </div>
        <div>
            {{ form.rate_of_pay_expected.label_tag }}
            <div class="monetary-field-container">
                {{ form.rate_of_pay_expected }}
            </div>
        </div>
        <div class="form-row">
            {{ form.ever_been_bonded.label_tag }} {{ form.ever_been_bonded }}
        </div>
        <div id="conditional-fields-3" style="display: none;">
            <div>
            {{ form.name_of_bonding_company.label_tag }} {{ form.name_of_bonding_company }}
        </div>
        </div>
        <div class="job-border"></div>
        <div>
            {{ form.unable_perform.label_tag }} {{ form.unable_perform }}
        </div>
        <div>
            {{ form.reason_unable_perform.label_tag }} {{ form.reason_unable_perform }}
        </div>
    </div>

    <div class="section-header">
        <h2>Section 3: Employment History</h2>
        <button type="button" class="toggle-section" data-target="#section3-content">+</button>
    </div>
    <div id="section3-content" class="collapsible-content collapsed">
        <p>All driver applicants to drive in interstate commerce must provide the following information on all employers
            during the preceding 3 years. List complete mailing address, street number, city, state and zip code.</p>
        <p>Applicants to drive a commercial motor vehicle* in intrastate or interstate commerce shall also provide an
            additional 7 years' information on those employers for whom the applicant operated such vehicle.</p>
        <p>(NOTE: List employers in reverse order starting with the most recent. Add another sheet as necessary.)</p>
        <p><i>*Includes vehicles having a GVWR of 26,001 lbs. or more, vehicles designed to transport 16 or more passengers
            (including the driver), or any size vehicle used to transport hazardous materials in a quantity requiring placarding.</i></p>
        <div id="employment-history-formset">
            {{ employment_history_formset.management_form }}
            {% for form in employment_history_formset %}
            <div class="employment-history-form">
                <div class="employment-history-header">
                    <h3>Employment History {{ forloop.counter }}</h3>
                    <button type="button" class="delete-employment-history">Delete</button>
                </div>
                {{ form.non_field_errors }}
                {{ form.as_p }}
            </div>
            {% endfor %}
            <div class="add-button-container">
                <button type="button" id="add-employment-history">Add Another Employment History</button>
            </div>
            <p><i>**The Federal Motor Carrier Safety Regulations (FMCSRs) apply to anyone operating a motor vehicle on a highway in
                interstate commerce to transport passengers or property when the vehicle:</i></p>
            <p><i>(1) weighs or has a GVWR of 10,001 pounds or more,</i></p>
            <p><i>(2) is designed or used to transport more than 8 passengers (including the driver), OR</i></p>
            <p><i>(3) is of any size and is used to transport hazardous materials in a quantity requiring placarding.</i></p>
        </div>
    </div>

    <div class="section-header">
        <h2>Section 4: Accident Record</h2>
        <button type="button" class="toggle-section" data-target="#section4-content">+</button>
    </div>
    <div id="section4-content" class="collapsible-content collapsed">
        <p><strong>ACCIDENT RECORD</strong> for the past 3 years or more</p>
        <div id="accident-record-formset">
            {{ accident_record_formset.management_form }}
            {% for form in accident_record_formset %}
            <div class="employment-history-form">
                <div class="employment-history-header">
                    <h3>Accident Record {{ forloop.counter }}</h3>
                    <button type="button" class="delete-employment-history">Delete</button>
                </div>
                {{ form.non_field_errors }}
                {{ form.as_p }}
            </div>
            {% endfor %}
            <div class="add-button-container">
                <button type="button" id="add-accident-record">Add Another Accident Record</button>
            </div>
        </div>
    </div>
    
    <div class="section-header">
        <h2>Section 5: Traffic Convictions</h2>
        <button type="button" class="toggle-section" data-target="#section5-content">+</button>
    </div>
    <div id="section5-content" class="collapsible-content collapsed">
        <div id="traffic-conviction-formset">
            {{ traffic_conviction_formset.management_form }}
            {% for form in traffic_conviction_formset %}
            <div class="traffic-conviction-form">
                {{ form.non_field_errors }}
                {{ form.as_p }}
            </div>
            {% endfor %}
            <div class="add-button-container">
                <button type="button" id="add-traffic-conviction">Add Another Traffic Conviction</button>
            </div>
        </div>
    </div>
    
    <div class="section-header">
        <h2>Section 6: License Information</h2>
        <button type="button" class="toggle-section" data-target="#section6-content">+</button>
    </div>
    <div id="section6-content" class="collapsible-content collapsed">
        <div id="license-information-formset">
            {{ license_formset.management_form }}
            {% for form in license_formset %}
            <div class="license-information-form">
                {{ form.non_field_errors }}
                {{ form.as_p }}
            </div>
            {% endfor %}
            <div class="add-button-container">
                <button type="button" id="add-license">Add Another License</button>
            </div>
        </div>
        <div>
            {{ license_2_form.denied_license.label_tag }} {{ license_2_form.denied_license }}
        </div>
        <div>
            {{ license_2_form.suspended_license.label_tag }} {{ license_2_form.suspended_license }}
        </div>
        <div>
            {{ license_2_form.license_details.label_tag }} {{ license_2_form.license_details }}
        </div>
    </div>

    <div class="submit-container">
        <button type="submit">Submit Application</button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButtons = document.querySelectorAll('.toggle-section');
    
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const target = document.querySelector(this.dataset.target);
                target.classList.toggle('expanded');
                this.textContent = target.classList.contains('expanded') ? '-' : '+';
    
                // Validate the section when the button is clicked
                if (this.textContent === '+') validateSection(target, this);
            });
        });
        
        function validateSection(section, button) {
            const inputs = section.querySelectorAll('input, select, textarea');
            let allValid = true;
            
            inputs.forEach(input => {
                // Check if the input is mandatory
                const isMandatory = input.hasAttribute('required') || input.closest('div[data-mandatory="true"]');
                
                // Check if the input is empty
                const isEmpty = input.value.trim() === '';
                
                // Remove previous error message and styles
                input.classList.remove('invalid-field');
                const errorMessage = input.parentElement.querySelector('.error-message');
                if (errorMessage) errorMessage.remove();
                
                // If the input is mandatory and empty, mark it as invalid
                if (isMandatory && isEmpty) {
                    allValid = false;
                    input.classList.add('invalid-field');
                    const errorSpan = document.createElement('span');
                    errorSpan.classList.add('error-message');
                    errorSpan.textContent = 'This field is required';
                    input.parentElement.appendChild(errorSpan);
                }
                
                if (allValid) {
                    button.classList.remove('invalid');
                    button.classList.add('valid');
                } else {
                    button.classList.remove('valid');
                    button.classList.add('invalid');
                }
            });
        }

        const addEmploymentHistoryButton = document.getElementById('add-employment-history');
        let employmentHistoryFormset = document.getElementById('employment-history-formset');
        let totalForms = employmentHistoryFormset.querySelector('input[name$="-TOTAL_FORMS"]');
        let formCount = parseInt(totalForms.value);
        
        function updateEmploymentHistoryHeaders() {
            const headers = employmentHistoryFormset.querySelectorAll('.employment-history-form h3');
            headers.forEach((header, index) => {
                header.textContent = `Employment History ${index + 1}`;
            });
        }
        
        function updateAddButtonVisibility() {
            if (formCount >= 5) {
                addEmploymentHistoryButton.style.display = 'none';
            } else {
                addEmploymentHistoryButton.style.display = 'block';
            }
        }
        
        function updateFirstDeleteButtonVisibility() {
            const firstDeleteButton = employmentHistoryFormset.querySelector('.employment-history-form .delete-employment-history');
            
            if (formCount === 1) {
                firstDeleteButton.style.display = 'none';
            } else {
                firstDeleteButton.style.display = 'block';
            }
        }
    
        addEmploymentHistoryButton.addEventListener('click', function() {
            if (formCount < 5) {
                const newForm = employmentHistoryFormset.querySelector('.employment-history-form').cloneNode(true);
                newForm.querySelectorAll('input, select, textarea').forEach(input => {
                    const name = input.name.replace(/-\d+-/, `-${formCount}-`);
                    const id = input.id.replace(/-\d+-/, `-${formCount}-`);
                    input.name = name;
                    input.id = id;
                    input.value = '';
                });
                
                // Update the subheader
                const subheader = newForm.querySelector('h3');
                subheader.textContent = `Employment History ${formCount + 1}`;
                
                // Add event listener to the delete button
                const deleteButton = newForm.querySelector('.delete-employment-history');
                deleteButton.style.display = 'block';
                deleteButton.addEventListener('click', function() {
                    newForm.remove();
                    formCount--;
                    totalForms.value = formCount.toString();
                    updateEmploymentHistoryHeaders();
                    updateAddButtonVisibility();
                    updateFirstDeleteButtonVisibility();
                });
                
                const container = addEmploymentHistoryButton.parentElement;
                employmentHistoryFormset.insertBefore(newForm, container);
                formCount++;
                totalForms.value = formCount.toString();
                updateAddButtonVisibility();
                updateFirstDeleteButtonVisibility();
            }
        });
        
        // Attach delete functionality to initial forms
        const initialDeleteButtons = employmentHistoryFormset.querySelectorAll('.delete-employment-history');
        initialDeleteButtons.forEach((button, index) => {
            button.addEventListener('click', function(event) {
                const form = event.target.closest('.employment-history-form');
                form.remove();
                formCount--;
                totalForms.value = formCount.toString();
                updateEmploymentHistoryHeaders();
                updateAddButtonVisibility();
                updateFirstDeleteButtonVisibility();
            });
        });

        updateEmploymentHistoryHeaders();
        updateAddButtonVisibility();
        updateFirstDeleteButtonVisibility();

        // Similar JavaScript for other dynamic sections.
        
        // Format phone number as (123) 456-7890
        const formatPhoneNumber = (input) => {
            let value = input.value.replace(/\D/g, ''); // Remove all non-digit characters
            if (value.length > 10) value = value.substring(0, 10); // Limit to 10 digits
    
            if (value.length > 6) {
                input.value = `(${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6)}`;
            } else if (value.length > 3) {
                input.value = `(${value.substring(0, 3)}) ${value.substring(3)}`;
            } else if (value.length > 0) {
                input.value = `(${value}`;
            }
        };

        // Format SSN as 123-45-6789
        const formatSSN = (input) => {
            let value = input.value.replace(/\D/g, ''); // Remove all non-digit characters
            if (value.length > 9) value = value.substring(0, 9); // Limit to 9 digits
    
            if (value.length > 5) {
                input.value = `${value.substring(0, 3)}-${value.substring(3, 5)}-${value.substring(5)}`;
            } else if (value.length > 3) {
                input.value = `${value.substring(0, 3)}-${value.substring(3)}`;
            } else {
                input.value = value;
            }
        };
    
        // Attach event listeners to the input fields
        const phoneNumberField = document.getElementById('id_phone_number');
        if (phoneNumberField) {
            phoneNumberField.addEventListener('input', () => formatPhoneNumber(phoneNumberField));
        }
    
        const ssnField = document.getElementById('id_social_security_number');
        if (ssnField) {
            ssnField.addEventListener('input', () => formatSSN(ssnField));
        }
        
        // Monetary fields script
        const monetaryFields = document.querySelectorAll('.monetary-field');
        
        monetaryFields.forEach(field => {
            field.addEventListener('input', function () {
                let value = parseFloat(this.value.replace(/[^0-9.]/g, '')).toFixed(2);
                this.value = isNaN(value) ? '' : value;
            });
        });
        
        // Toggle visibility of worked here before fields
        function toggleWorkedHereBeforeFields() {
            const workedHereBeforeCheckbox = document.getElementById('id_worked_here_before');
            const conditionalFields = document.getElementById('conditional-fields-1');
            
            if (workedHereBeforeCheckbox.checked) {
                conditionalFields.style.display = 'block';
            } else {
                conditionalFields.style.display = 'none';
            }
        }
        const workedHereBefore = document.getElementById('id_worked_here_before');
        workedHereBefore.addEventListener('change', toggleWorkedHereBeforeFields);
        
        // Toggle visibility of currently employed fields
        function toggleCurrentlyEmployedFields() {
            const currentlyEmployedCheckbox = document.getElementById('id_currently_employed');
            const conditionalFields = document.getElementById('conditional-fields-2');
            
            if (currentlyEmployedCheckbox.checked) {
                conditionalFields.style.display = 'none';
            } else {
                conditionalFields.style.display = 'block';
            }
        }
        const currentlyEmployed = document.getElementById('id_currently_employed');
        currentlyEmployed.addEventListener('change', toggleCurrentlyEmployedFields);
        
        // Toggle visibility of bonded fields
        function toggleBondedFields() {
            const currentlyEmployedCheckbox = document.getElementById('id_ever_been_bonded');
            const conditionalFields = document.getElementById('conditional-fields-3');
            
            if (currentlyEmployedCheckbox.checked) {
                conditionalFields.style.display = 'block';
            } else {
                conditionalFields.style.display = 'none';
            }
        }
        const bonded = document.getElementById('id_ever_been_bonded');
        bonded.addEventListener('change', toggleBondedFields);
    
        // Initialize the visibility on page load
        toggleWorkedHereBeforeFields();
        toggleCurrentlyEmployedFields();
        toggleBondedFields();
    });
</script>
{% endblock %}
